<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Amina - Mental Health Counselor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #6c5ce7 50%, #a29bfe 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
            padding: 40px;
            text-align: center;
        }

        h1 {
            color: #2d3436;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .subtitle {
            color: #636e72;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .status {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .status.idle {
            background: #d1f2eb;
            color: #00b894;
        }

        .status.recording {
            background: #ffeaa7;
            color: #e17055;
            animation: pulse 1.5s infinite;
        }

        .status.processing {
            background: #e8f4f8;
            color: #0984e3;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .controls {
            margin-bottom: 30px;
        }

        .record-btn {
            background: linear-gradient(45deg, #00b894, #00a085);
            color: white;
            border: none;
            border-radius: 50%;
            width: 130px;
            height: 130px;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 15px;
            box-shadow: 0 15px 35px rgba(0, 184, 148, 0.3);
        }

        .record-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 45px rgba(0, 184, 148, 0.4);
        }

        .record-btn:active {
            transform: translateY(0);
        }

        .record-btn.recording {
            background: linear-gradient(45deg, #e17055, #d63031);
            animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .therapy-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .therapy-btn {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(116, 185, 255, 0.3);
        }

        .therapy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(116, 185, 255, 0.4);
        }

        .therapy-btn.secondary {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            box-shadow: 0 5px 20px rgba(108, 92, 231, 0.3);
        }

        .therapy-btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 92, 231, 0.4);
        }

        .conversation {
            max-height: 450px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 20px;
            text-align: left;
        }

        .message {
            margin-bottom: 20px;
            padding: 18px 22px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
            margin-right: auto;
        }

        .audio-player {
            width: 100%;
            margin-top: 15px;
            border-radius: 25px;
        }

        .latency-info {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            display: inline-block;
        }

        .latency-info.fast {
            background: rgba(0, 184, 148, 0.8);
        }

        .latency-info.medium {
            background: rgba(255, 159, 67, 0.8);
        }

        .latency-info.slow {
            background: rgba(209, 52, 49, 0.8);
        }



        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00b894;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #d63031;
            background: #ffebee;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            display: none;
        }

        .error.show {
            display: block;
        }

        .instructions {
            background: linear-gradient(45deg, #d1f2eb, #b8e6d3);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            color: #00b894;
            border: 2px solid rgba(0, 184, 148, 0.2);
        }

        .instructions h3 {
            margin-bottom: 15px;
            color: #00a085;
            font-size: 1.2em;
        }

        .instructions ul {
            text-align: left;
            margin-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
            line-height: 1.5;
        }

        .therapy-info {
            background: linear-gradient(45deg, #e8f4f8, #d6eaf8);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            color: #0984e3;
            border: 2px solid rgba(9, 132, 227, 0.2);
        }

        .crisis-banner {
            background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: #e17055;
            border: 2px solid rgba(225, 112, 85, 0.2);
            font-size: 0.9em;
        }

        .crisis-banner strong {
            color: #d63031;
        }

        .session-info {
            background: linear-gradient(45deg, #f5f3ff, #e8e5ff);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            color: #6c5ce7;
            display: none;
        }

        /* Status indicator styles */
        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .status.idle {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
        }

        .status.recording {
            background: linear-gradient(45deg, #e17055, #d63031);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status.processing {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status.speaking {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status.loading {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.8;
                transform: scale(1.02);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .record-btn {
                width: 110px;
                height: 110px;
                font-size: 24px;
            }



            .therapy-actions {
                flex-direction: column;
                align-items: center;
            }

            .therapy-btn {
                width: 100%;
                max-width: 300px;
            }
        }

        /* HIPAA Consent Modal Styles */
        .consent-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .consent-overlay.hidden {
            display: none;
        }

        .consent-modal {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            max-height: 90vh;
            width: 100%;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .consent-header {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .consent-header h2 {
            margin: 0 0 10px 0;
            font-size: 1.8em;
            font-weight: 600;
        }

        .consent-subtitle {
            margin: 0;
            font-size: 1em;
            opacity: 0.9;
        }

        .consent-content {
            padding: 30px;
        }

        .important-notice {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .important-notice h3 {
            color: #dc2626;
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        .important-notice ul {
            margin: 0;
            padding-left: 20px;
        }

        .important-notice li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .privacy-details {
            margin: 25px 0;
        }

        .privacy-details h3 {
            color: #1f2937;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }

        .privacy-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #3b82f6;
        }

        .privacy-section h4 {
            color: #374151;
            margin: 0 0 12px 0;
            font-size: 1.1em;
        }

        .privacy-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .privacy-section li {
            margin: 6px 0;
            line-height: 1.4;
        }

        .consent-agreements {
            margin: 30px 0;
        }

        .consent-agreements h3 {
            color: #1f2937;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }

        .consent-checkbox-item {
            display: flex;
            align-items: flex-start;
            margin: 20px 0;
            cursor: pointer;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .consent-checkbox-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .consent-checkbox-item.checked {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .consent-checkbox-item input[type="checkbox"] {
            margin-right: 15px;
            margin-top: 2px;
            transform: scale(1.3);
            cursor: pointer;
            accent-color: #10b981;
        }

        .consent-text {
            flex: 1;
            font-size: 0.95em;
            color: #374151;
            line-height: 1.5;
        }

        .consent-text strong {
            color: #1f2937;
            display: block;
            margin-bottom: 5px;
        }

        .consent-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0 20px 0;
            flex-wrap: wrap;
        }

        .consent-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .decline-btn {
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid #d1d5db;
        }

        .decline-btn:hover {
            background: #e5e7eb;
            color: #4b5563;
        }

        .accept-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .accept-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .accept-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .consent-footer {
            text-align: center;
            color: #6b7280;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .consent-footer p {
            margin: 8px 0;
        }

        /* Disable main container when consent not given */
        .main-container-disabled {
            pointer-events: none;
            opacity: 0.3;
            user-select: none;
        }

        /* Mobile responsive for consent modal */
        @media (max-width: 768px) {
            .consent-overlay {
                padding: 10px;
            }
            
            .consent-modal {
                max-height: 95vh;
            }
            
            .consent-header {
                padding: 20px;
            }
            
            .consent-header h2 {
                font-size: 1.5em;
            }
            
            .consent-content {
                padding: 20px;
            }
            
            .consent-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .consent-btn {
                width: 100%;
                max-width: 280px;
            }
            
            .consent-checkbox-item {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- HIPAA Consent Modal - Blocks all functionality until consent given -->
    <div class="consent-overlay" id="consentOverlay">
        <div class="consent-modal">
            <div class="consent-header">
                <h2>🔒 HIPAA Privacy Notice & Consent</h2>
                <p class="consent-subtitle">Required before using Dr. Amina Mental Health Support</p>
            </div>
            
            <div class="consent-content">
                <div class="important-notice">
                    <h3>⚠️ Important Information</h3>
                    <ul>
                        <li><strong>AI Assistant:</strong> Dr. Amina is an AI-powered assistant, NOT a licensed therapist or medical professional</li>
                        <li><strong>Emergency:</strong> For mental health crises, contact emergency services: <strong>119 ext. 8</strong> or <strong>021-500-454</strong></li>
                        <li><strong>Professional Help:</strong> This service does not replace professional mental health treatment</li>
                    </ul>
                </div>

                <div class="privacy-details">
                    <h3>🛡️ Data Protection & Privacy</h3>
                    <div class="privacy-section">
                        <h4>What Data We Collect:</h4>
                        <ul>
                            <li>Voice recordings (temporarily processed for AI responses)</li>
                            <li>Text conversations (for therapeutic interaction)</li>
                            <li>Anonymous session ID (no personal identification)</li>
                            <li>Technical logs (for system maintenance only)</li>
                        </ul>
                    </div>
                    
                    <div class="privacy-section">
                        <h4>What We DON'T Collect:</h4>
                        <ul>
                            <li>❌ Your real name, email, or phone number</li>
                            <li>❌ Location data or device tracking</li>
                            <li>❌ Insurance or payment information</li>
                            <li>❌ Social media or personal accounts</li>
                        </ul>
                    </div>

                    <div class="privacy-section">
                        <h4>Data Protection Measures:</h4>
                        <ul>
                            <li>🔐 All data encrypted during transmission (HTTPS/TLS)</li>
                            <li>⏰ Automatic deletion after 30 days maximum</li>
                            <li>🚫 No data sharing with third parties</li>
                            <li>📋 Audit logging for compliance</li>
                            <li>🔒 Anonymous user identification only</li>
                        </ul>
                    </div>
                </div>

                <div class="consent-agreements">
                    <h3>📋 Required Consent Items</h3>
                    
                    <label class="consent-checkbox-item">
                        <input type="checkbox" id="aiUnderstanding" required>
                        <span class="checkmark"></span>
                        <div class="consent-text">
                            <strong>AI Assistant Understanding:</strong> I understand that Dr. Amina is an artificial intelligence assistant and not a licensed mental health professional, therapist, or medical doctor.
                        </div>
                    </label>

                    <label class="consent-checkbox-item">
                        <input type="checkbox" id="dataProcessingConsent" required>
                        <span class="checkmark"></span>
                        <div class="consent-text">
                            <strong>Data Processing Consent:</strong> I consent to the temporary processing of my voice recordings and text conversations for the purpose of generating AI-powered therapeutic responses.
                        </div>
                    </label>

                    <label class="consent-checkbox-item">
                        <input type="checkbox" id="dataRetentionConsent" required>
                        <span class="checkmark"></span>
                        <div class="consent-text">
                            <strong>Data Retention Understanding:</strong> I understand that my conversation data will be stored temporarily and automatically deleted within 30 days, and that I can request deletion at any time.
                        </div>
                    </label>

                    <label class="consent-checkbox-item">
                        <input type="checkbox" id="emergencyUnderstanding" required>
                        <span class="checkmark"></span>
                        <div class="consent-text">
                            <strong>Emergency Protocol:</strong> I understand that this service is not for mental health emergencies, and I will contact emergency services (119 ext. 8 or 021-500-454) if I have thoughts of self-harm or crisis situations.
                        </div>
                    </label>

                    <label class="consent-checkbox-item">
                        <input type="checkbox" id="voluntaryParticipation" required>
                        <span class="checkmark"></span>
                        <div class="consent-text">
                            <strong>Voluntary Participation:</strong> I am voluntarily using this AI mental health support service and can discontinue use at any time.
                        </div>
                    </label>
                </div>

                <div class="consent-actions">
                    <button class="consent-btn decline-btn" id="declineConsent">
                        ❌ Decline - I do not agree
                    </button>
                    <button class="consent-btn accept-btn" id="acceptConsent" disabled>
                        ✅ Accept All & Continue
                    </button>
                </div>

                <div class="consent-footer">
                    <p><small>By accepting, you acknowledge reading and understanding this HIPAA privacy notice and consent to the described data processing practices.</small></p>
                    <p><small>Last updated: January 2025 | Version: 1.0</small></p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <h1>🧠 Dr. Amina</h1>
        <p class="subtitle">Mental Health Counselor with Omani Cultural Understanding</p>
        
        <div class="crisis-banner">
            <strong>🚨 Mental Health Crisis:</strong> If you're having thoughts of harming yourself or others, please call 
            <strong>119 ext. 8</strong> (Health Ministry Hotline) or <strong>021-500-454</strong> (Mental Health Hotline) for emergency assistance.
        </div>
        
        <div class="instructions">
            <h3>🌟 How I Can Help You:</h3>
            <ul>
                <li>🎤 Click the green button to start speaking</li>
                <li>💬 Share your feelings or concerns in <strong>English or Arabic</strong></li>
                <li>🤝 I will listen with empathy and provide support</li>
                <li>🕊️ All conversations are confidential and secure</li>
                <li>🌸 I understand Omani cultural and Islamic values</li>
            </ul>
        </div>

        <div class="therapy-info">
            <p style="margin-bottom: 10px;">
                💚 <strong>Therapeutic Approach:</strong> I use an approach that is sensitive to Omani culture, respects Islamic values, and understands Omani family dynamics.
            </p>
            <p style="font-size: 0.9em; margin-top: 10px;">
                🎯 <strong>Service Focus:</strong> Anxiety, depression, stress, family issues, social pressure, and emotional support.
            </p>
        </div>

        <div class="status idle" id="status">
            🔊 Click anywhere to activate audio and hear a welcome message from Dr. Amina
        </div>

        <div class="session-info" id="sessionInfo">
            <p>🔄 <span id="contextInfo">Session information will appear here</span></p>
        </div>



        <div class="controls">
            <button class="record-btn" id="recordBtn">🔊</button>
            <div class="therapy-actions">
                <button class="therapy-btn" id="clearBtn">🔄 Start New Session</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing with full attention...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="conversation" id="conversation"></div>
    </div>

    <script>
        // HIPAA Consent Management System
        class HIPAAConsentManager {
            constructor() {
                this.consentGiven = false;
                this.consentData = {};
                this.consentTimestamp = null;
                
                // DOM elements
                this.consentOverlay = document.getElementById('consentOverlay');
                this.mainContainer = document.getElementById('mainContainer');
                this.acceptBtn = document.getElementById('acceptConsent');
                this.declineBtn = document.getElementById('declineConsent');
                
                // Checkbox elements
                this.checkboxes = {
                    aiUnderstanding: document.getElementById('aiUnderstanding'),
                    dataProcessingConsent: document.getElementById('dataProcessingConsent'),
                    dataRetentionConsent: document.getElementById('dataRetentionConsent'),
                    emergencyUnderstanding: document.getElementById('emergencyUnderstanding'),
                    voluntaryParticipation: document.getElementById('voluntaryParticipation')
                };
                
                this.initializeConsentSystem();
            }
            
            initializeConsentSystem() {
                console.log('🔒 Initializing HIPAA Consent System');
                
                // Check if consent was previously given (session-based, not persistent)
                const sessionConsent = sessionStorage.getItem('hipaa_consent_given');
                if (sessionConsent) {
                    const consentData = JSON.parse(sessionConsent);
                    if (this.isConsentValid(consentData)) {
                        this.consentGiven = true;
                        this.hideConsentModal();
                        this.enableMainApp();
                        return;
                    }
                }
                
                // Show consent modal and disable main app
                this.showConsentModal();
                this.disableMainApp();
                
                // Add event listeners
                this.addEventListeners();
            }
            
            addEventListeners() {
                // Checkbox change events
                Object.values(this.checkboxes).forEach(checkbox => {
                    checkbox.addEventListener('change', () => this.validateAllConsents());
                });
                
                // Button events
                this.acceptBtn.addEventListener('click', () => this.handleAcceptConsent());
                this.declineBtn.addEventListener('click', () => this.handleDeclineConsent());
                
                // Visual feedback for checkboxes
                Object.values(this.checkboxes).forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const item = e.target.closest('.consent-checkbox-item');
                        if (e.target.checked) {
                            item.classList.add('checked');
                        } else {
                            item.classList.remove('checked');
                        }
                    });
                });
            }
            
            validateAllConsents() {
                const allChecked = Object.values(this.checkboxes).every(checkbox => checkbox.checked);
                
                this.acceptBtn.disabled = !allChecked;
                
                if (allChecked) {
                    this.acceptBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    this.acceptBtn.style.cursor = 'pointer';
                } else {
                    this.acceptBtn.style.background = '#9ca3af';
                    this.acceptBtn.style.cursor = 'not-allowed';
                }
                
                return allChecked;
            }
            
            handleAcceptConsent() {
                if (!this.validateAllConsents()) {
                    this.showConsentError('Please check all required consent items before proceeding.');
                    return;
                }
                
                // Generate consent data
                this.consentData = {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    ipAddress: 'hidden_for_privacy', // Will be logged server-side
                    consentVersion: '1.0',
                    consentItems: {
                        aiUnderstanding: this.checkboxes.aiUnderstanding.checked,
                        dataProcessingConsent: this.checkboxes.dataProcessingConsent.checked,
                        dataRetentionConsent: this.checkboxes.dataRetentionConsent.checked,
                        emergencyUnderstanding: this.checkboxes.emergencyUnderstanding.checked,
                        voluntaryParticipation: this.checkboxes.voluntaryParticipation.checked
                    },
                    sessionId: this.generateSessionId(),
                    consentMethod: 'web_interface'
                };
                
                this.consentTimestamp = new Date();
                this.consentGiven = true;
                
                // Store in session storage (not localStorage for privacy)
                sessionStorage.setItem('hipaa_consent_given', JSON.stringify(this.consentData));
                
                // Log consent for HIPAA audit trail
                this.logConsentForAudit();
                
                // Hide modal and enable app
                this.hideConsentModal();
                this.enableMainApp();
                
                // Small delay to ensure everything is properly initialized
                setTimeout(() => {
                    console.log('✅ HIPAA Consent Successfully Granted - App Ready', this.consentData);
                }, 100);
                
                console.log('✅ HIPAA Consent Successfully Granted', this.consentData);
            }
            
            handleDeclineConsent() {
                // Log declined consent
                const declineData = {
                    timestamp: new Date().toISOString(),
                    action: 'consent_declined',
                    userAgent: navigator.userAgent
                };
                
                console.log('❌ HIPAA Consent Declined', declineData);
                
                // Show decline message and redirect or close
                this.showDeclineMessage();
            }
            
            showDeclineMessage() {
                alert('Thank you for your time. Since consent is required to use this mental health support service, you will now be redirected away from the application.\n\nIf you change your mind, you can return and provide consent at any time.');
                
                // Redirect to a safe page or close window
                window.location.href = 'about:blank';
            }
            
            showConsentError(message) {
                // Create temporary error message
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fee2e2;
                    border: 2px solid #fca5a5;
                    color: #dc2626;
                    padding: 15px 20px;
                    border-radius: 10px;
                    z-index: 10001;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                errorDiv.textContent = message;
                
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    document.body.removeChild(errorDiv);
                }, 5000);
            }
            
            generateSessionId() {
                return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }
            
            isConsentValid(consentData) {
                if (!consentData || !consentData.timestamp) return false;
                
                // Check if consent is within current session (expires when browser closes)
                const consentTime = new Date(consentData.timestamp);
                const now = new Date();
                const hoursDiff = (now - consentTime) / (1000 * 60 * 60);
                
                // Consent valid for 8 hours or current session, whichever is shorter
                return hoursDiff < 8 && consentData.consentItems && 
                       Object.values(consentData.consentItems).every(item => item === true);
            }
            
            logConsentForAudit() {
                // HIPAA Audit Log Entry
                const auditEntry = {
                    eventType: 'HIPAA_CONSENT_GRANTED',
                    timestamp: this.consentData.timestamp,
                    sessionId: this.consentData.sessionId,
                    consentVersion: this.consentData.consentVersion,
                    ipAddress: 'logged_server_side', // Actual IP logged server-side
                    userAgent: navigator.userAgent.substring(0, 100), // Truncated for privacy
                    consentMethod: 'web_interface_checkbox',
                    dataMinimization: true,
                    anonymousUser: true
                };
                
                // Log to console for development (in production, send to secure audit server)
                console.log('📋 HIPAA Audit Log:', auditEntry);
                
                // In production, you would send this to your secure audit endpoint:
                // fetch('/audit/consent', { method: 'POST', body: JSON.stringify(auditEntry) });
            }
            
            showConsentModal() {
                this.consentOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
            
            hideConsentModal() {
                this.consentOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
            
            disableMainApp() {
                this.mainContainer.classList.add('main-container-disabled');
            }
            
            enableMainApp() {
                this.mainContainer.classList.remove('main-container-disabled');
                
                // Ensure the bot is properly initialized after consent
                if (window.bot) {
                    window.bot.reinitializeAfterConsent();
                }
            }
            
            // Public methods for other components
            hasValidConsent() {
                return this.consentGiven && this.consentData && this.isConsentValid(this.consentData);
            }
            
            getConsentData() {
                return this.hasValidConsent() ? this.consentData : null;
            }
            
            revokeConsent() {
                this.consentGiven = false;
                this.consentData = {};
                sessionStorage.removeItem('hipaa_consent_given');
                this.showConsentModal();
                this.disableMainApp();
                
                console.log('🔄 HIPAA Consent Revoked - User must re-consent');
            }
        }

        class OmaniMentalHealthBot {
            constructor() {
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.sessionId = null;
                this.messageCount = 0;
                this.startTime = null;
                this.audioEnabled = false;
                this.welcomePlayed = false;
                
                this.recordBtn = document.getElementById('recordBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.conversation = document.getElementById('conversation');
                this.loading = document.getElementById('loading');
                this.error = document.getElementById('error');
                this.sessionInfo = document.getElementById('sessionInfo');
                this.contextInfo = document.getElementById('contextInfo');
                
                // Wait for consent manager to be available
                this.consentManager = null;
                this.initializeAfterConsent();
            }

            initializeAfterConsent() {
                // Wait for consent manager to be available
                const waitForConsent = () => {
                    if (window.consentManager) {
                        this.consentManager = window.consentManager;
                        this.initEventListeners();
                        this.initializeAudioAndWelcome();
                    } else {
                        setTimeout(waitForConsent, 100);
                    }
                };
                waitForConsent();
            }

            reinitializeAfterConsent() {
                console.log('🔄 Reinitializing bot after consent granted');
                
                // Ensure consent manager is available
                if (window.consentManager) {
                    this.consentManager = window.consentManager;
                }
                
                // Re-initialize audio and welcome flow
                this.initializeAudioAndWelcome();
                
                // Ensure button is properly enabled
                this.recordBtn.disabled = false;
                this.recordBtn.style.pointerEvents = 'auto';
                this.recordBtn.style.cursor = 'pointer';
                
                console.log('✅ Bot reinitialiation complete - microphone ready!');
            }

            checkConsentBeforeAction(actionName) {
                if (!this.consentManager || !this.consentManager.hasValidConsent()) {
                    console.warn(`🔒 Action blocked: ${actionName} - HIPAA consent required`);
                    this.showError('HIPAA consent is required before using this mental health support service.');
                    return false;
                }
                return true;
            }

            initEventListeners() {
                this.recordBtn.addEventListener('click', async (event) => {
                    console.log('🎤 Microphone button clicked!', {
                        audioEnabled: this.audioEnabled,
                        isRecording: this.isRecording,
                        consentValid: this.consentManager ? this.consentManager.hasValidConsent() : false
                    });
                    
                    // Check consent before any recording action
                    if (!this.checkConsentBeforeAction('recording')) {
                        console.log('❌ Consent check failed - blocking action');
                        return;
                    }
                    
                    try {
                        // Enable audio on first interaction if not already enabled
                        if (!this.audioEnabled) {
                            console.log('🔊 Enabling audio for first time...');
                            await this.enableAudioAndPlayWelcome();
                            return;
                        }
                        
                        if (this.isRecording) {
                            console.log('⏹️ Stopping recording...');
                            this.stopRecording();
                        } else {
                            console.log('🎙️ Starting recording...');
                            await this.startRecording();
                        }
                    } catch (error) {
                        console.error('❌ Error in record button click:', error);
                        this.showError('Error with microphone: ' + error.message);
                    }
                });

                // Add click-anywhere-to-enable functionality
                document.addEventListener('click', async (event) => {
                    if (!this.audioEnabled && event.target !== this.recordBtn && this.checkConsentBeforeAction('audio_activation')) {
                        console.log('🔊 Enabling audio from document click...');
                        await this.enableAudioAndPlayWelcome();
                    }
                }, { once: true });

                this.clearBtn.addEventListener('click', () => {
                    if (this.checkConsentBeforeAction('clear_conversation')) {
                        this.clearConversation();
                    }
                });
            }

            async initializeAudioAndWelcome() {
                console.log('🚀 Initializing audio and welcome...');
                
                // Show status based on consent
                if (!this.consentManager || !this.consentManager.hasValidConsent()) {
                    this.status.textContent = '🔒 Please complete the HIPAA consent process to begin';
                    this.status.className = 'status idle';
                    this.recordBtn.disabled = true;
                    return;
                }
                
                // Show prompt to enable audio
                this.status.textContent = '🔊 Click the microphone to activate audio and hear a welcome message from Dr. Amina';
                this.status.className = 'status idle';
                
                // Show a visual indicator that audio is not yet enabled
                this.recordBtn.textContent = '🎤';
                this.recordBtn.style.background = 'linear-gradient(45deg, #74b9ff, #0984e3)';
                this.recordBtn.disabled = false; // Ensure button is enabled
                this.recordBtn.style.pointerEvents = 'auto'; // Ensure button is clickable
                this.recordBtn.style.cursor = 'pointer';
                this.recordBtn.style.opacity = '1'; // Ensure button is visible
                
                console.log('✅ Button initialized and ready for clicks', {
                    disabled: this.recordBtn.disabled,
                    pointerEvents: this.recordBtn.style.pointerEvents,
                    cursor: this.recordBtn.style.cursor,
                    consentValid: this.consentManager ? this.consentManager.hasValidConsent() : false
                });
            }

            async enableAudioAndPlayWelcome() {
                if (this.audioEnabled || !this.checkConsentBeforeAction('enable_audio')) return;
                
                try {
                    // Test audio capability by creating a silent audio context
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    await audioContext.resume();
                    audioContext.close();
                    
                    this.audioEnabled = true;
                    
                    // Reset button appearance
                    this.recordBtn.textContent = '🎤';
                    this.recordBtn.style.background = '';
                    
                    // Play welcome message immediately
                    if (!this.welcomePlayed) {
                        await this.showWelcomeMessage();
                        this.welcomePlayed = true;
                    }
                    
                } catch (error) {
                    console.error('Failed to enable audio:', error);
                    this.status.textContent = 'Audio could not be activated. Please use text mode.';
                    this.status.className = 'status idle';
                    
                    // Show welcome message without audio as fallback
                    if (!this.welcomePlayed) {
                        await this.showWelcomeMessage();
                        this.welcomePlayed = true;
                    }
                }
            }

            async showWelcomeMessage() {
                if (!this.checkConsentBeforeAction('show_welcome')) return;
                
                // Add welcome message from therapist with mixed language support
                const welcomeMessage = `أهلاً وسهلاً! Assalamu alaikum and welcome! I'm Dr. Amina, your mental health counselor. 
                You can speak to me in Arabic, English, or naturally mix both languages - كيف ما يريحك. 
                Whether you say "I'm feeling stressed" or "أنا متوتر" or "Today I'm مو مبسوط", I'll understand completely. 
                What can I help you with today? شنو اللي يمكن أساعدك فيه؟`;

                try {
                    // Only generate TTS if audio is enabled
                    if (this.audioEnabled) {
                        // Show loading status
                        this.status.textContent = 'Dr. Amina is preparing a welcome message... 🎤';
                        this.status.className = 'status loading';
                        
                        // Generate TTS for welcome message
                        const response = await fetch('/text-to-speech', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: welcomeMessage,
                                session_id: this.getConsentSessionId()
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            // Add message with auto-playing audio
                            await this.addMessage(welcomeMessage, 'assistant', data.audio_url);
                            
                        } else {
                            // Fallback: show message without audio if TTS fails
                            console.warn('TTS failed for welcome message, showing text only');
                            await this.addMessage(welcomeMessage, 'assistant');
                            this.status.textContent = 'Ready to listen. Click the green button to speak.';
                            this.status.className = 'status idle';
                        }
                    } else {
                        // Show message without audio if audio not enabled
                        await this.addMessage(welcomeMessage, 'assistant');
                        this.status.textContent = 'Ready to listen. Click the green button to speak.';
                        this.status.className = 'status idle';
                    }
                    
                } catch (error) {
                    console.error('Error generating welcome voice:', error);
                    // Fallback: show message without audio if error occurs
                    await this.addMessage(welcomeMessage, 'assistant');
                    this.status.textContent = 'Ready to listen. Click the green button to speak.';
                    this.status.className = 'status idle';
                }
            }

            getConsentSessionId() {
                // Get session ID from consent data for audit trail
                const consentData = this.consentManager ? this.consentManager.getConsentData() : null;
                return consentData ? consentData.sessionId : null;
            }

            async startRecording() {
                if (!this.checkConsentBeforeAction('start_recording')) return;
                
                try {
                    this.startTime = Date.now();
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        this.audioChunks.push(event.data);
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                        this.sendAudioToTherapist(audioBlob);
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    
                    this.recordBtn.textContent = '⏹️';
                    this.recordBtn.classList.add('recording');
                    this.status.textContent = 'I\'m listening to you... Click stop when you\'re done speaking.';
                    this.status.className = 'status recording';
                    
                } catch (error) {
                    this.showError('Sorry, cannot access microphone: ' + error.message);
                }
            }

            stopRecording() {
                if (!this.checkConsentBeforeAction('stop_recording')) return;
                
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    
                    this.recordBtn.textContent = '🎤';
                    this.recordBtn.classList.remove('recording');
                    this.status.textContent = 'Processing with full attention...';
                    this.status.className = 'status processing';
                    
                    this.showLoading(true);
                }
            }

            async sendAudioToTherapist(audioBlob) {
                if (!this.checkConsentBeforeAction('send_audio')) return;
                
                try {
                    const formData = new FormData();
                    formData.append('audio_file', audioBlob, 'therapy_session.wav');
                    
                    // Use consent session ID for audit trail
                    const consentSessionId = this.getConsentSessionId();
                    if (consentSessionId) {
                        formData.append('session_id', consentSessionId);
                    } else if (this.sessionId) {
                        formData.append('session_id', this.sessionId);
                    }
                    
                    const response = await fetch('/voice-therapy', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const endTime = Date.now();
                        const latency = (endTime - this.startTime) / 1000;
                        
                        this.sessionId = data.session_id;
                        
                        this.addMessage(data.user_text, 'user');
                        
                        // Auto-play assistant response
                        this.status.textContent = 'Dr. Amina is speaking... 🗣️';
                        this.status.className = 'status speaking';
                        
                        await this.addMessage(data.ai_response, 'assistant', data.audio_url, latency);
                        
                    } else {
                        this.showError(data.error || 'An error occurred while processing your request.');
                    }
                    
                } catch (error) {
                    this.showError('Sorry, a technical error occurred: ' + error.message);
                    this.status.textContent = 'An error occurred. Please try again.';
                    this.status.className = 'status idle';
                } finally {
                    this.showLoading(false);
                }
            }

            async addMessage(text, sender, audioUrl = null, latency = null) {
                if (!this.checkConsentBeforeAction('add_message')) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                let latencyDisplay = '';
                if (sender === 'assistant' && latency !== null) {
                    const latencyClass = latency < 5 ? 'fast' : latency < 10 ? 'medium' : 'slow';
                    const status = latency < 20 ? '✅' : '⚠️';
                    latencyDisplay = `<div class="latency-info ${latencyClass}">
                        ${status} Response time: ${latency.toFixed(2)}s
                    </div>`;
                }
                
                // Create audio element with autoplay for assistant messages
                const audioElement = audioUrl ? `<audio ${sender === 'assistant' ? 'autoplay' : 'controls'} class="audio-player" id="audio-${Date.now()}">
                    <source src="${audioUrl}" type="audio/mpeg">
                    Browser Anda tidak mendukung pemutar audio.
                </audio>` : '';
                
                messageDiv.innerHTML = `
                    <p><strong>${sender === 'user' ? 'You' : 'Dr. Amina'}:</strong> ${text}</p>
                    ${audioElement}
                    ${latencyDisplay}
                `;
                
                this.conversation.appendChild(messageDiv);
                this.conversation.scrollTop = this.conversation.scrollHeight;
                
                // Auto-play assistant audio and handle events
                if (sender === 'assistant' && audioUrl) {
                    const audio = messageDiv.querySelector('audio');
                    if (audio) {
                        try {
                            // Add event listeners
                            audio.addEventListener('loadstart', () => {
                                this.status.textContent = 'Loading audio response... 🔄';
                                this.status.className = 'status loading';
                            });
                            
                            audio.addEventListener('canplay', () => {
                                this.status.textContent = 'Dr. Amina is speaking... 🗣️';
                                this.status.className = 'status speaking';
                            });
                            
                            audio.addEventListener('ended', () => {
                                this.status.textContent = 'Ready to listen to you again. Click the green button to speak.';
                                this.status.className = 'status idle';
                            });
                            
                            audio.addEventListener('error', (e) => {
                                console.error('Audio playback error:', e);
                                this.status.textContent = 'Ready to listen to you again. Click the green button to speak.';
                                this.status.className = 'status idle';
                            });
                            
                            // Try to play the audio
                            const playPromise = audio.play();
                            
                            if (playPromise !== undefined) {
                                await playPromise;
                            }
                            
                        } catch (error) {
                            console.error('Error playing audio:', error);
                            this.status.textContent = 'Audio cannot be played automatically. Please click the play button.';
                            this.status.className = 'status idle';
                            // Fallback: show controls if autoplay fails
                            audio.controls = true;
                            audio.removeAttribute('autoplay');
                        }
                    }
                }
                
                if (sender === 'user') {
                    this.messageCount++;
                    this.updateSessionInfo();
                }
            }

            updateSessionInfo() {
                if (this.messageCount > 0) {
                    const exchanges = this.messageCount;
                    this.contextInfo.textContent = `Therapy session: ${exchanges} conversation exchanges`;
                    this.sessionInfo.style.display = 'block';
                } else {
                    this.sessionInfo.style.display = 'none';
                }
            }



            async clearConversation() {
                if (!this.checkConsentBeforeAction('clear_conversation')) return;
                
                const confirm = window.confirm('Are you sure you want to start a new therapy session? Previous conversations will be deleted.');
                if (!confirm) return;

                try {
                    if (this.sessionId) {
                        await fetch(`/session/${this.sessionId}`, {
                            method: 'DELETE'
                        });
                    }
                    
                    this.conversation.innerHTML = '';
                    this.sessionId = null;
                    this.messageCount = 0;
                    this.startTime = null;
                    this.welcomePlayed = false; // Reset welcome message flag
                    
                    this.updateSessionInfo();
                    
                    // Play welcome message again for new session
                    if (this.audioEnabled) {
                        await this.showWelcomeMessage();
                        this.welcomePlayed = true;
                    } else {
                        // If audio not enabled, show prompt again
                        this.status.textContent = '🔊 Click anywhere to enable audio and hear a welcome from Dr. Amina';
                        this.status.className = 'status idle';
                    }
                    
                } catch (error) {
                    this.showError('Failed to delete session: ' + error.message);
                }
            }

            showLoading(show) {
                this.loading.classList.toggle('show', show);
            }

            showError(message) {
                this.error.textContent = message;
                this.error.classList.add('show');
                
                setTimeout(() => {
                    this.error.classList.remove('show');
                }, 8000);
            }
            
            showMessage(message) {
                this.addMessage(message, 'assistant');
            }
        }
        
        // Initialize the mental health bot when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Initializing HIPAA-Compliant Mental Health Bot');
            
            // Initialize consent manager first
            window.consentManager = new HIPAAConsentManager();
            
            // Initialize bot (it will wait for consent manager to be ready)
            window.bot = new OmaniMentalHealthBot();
            
            console.log('✅ Application initialization complete');
        });
    </script>
</body>
</html> 